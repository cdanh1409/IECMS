{"ast":null,"code":"// routers/powerlog.js\nconst express = require(\"express\");\nconst router = express.Router();\nconst {\n  poolPromise,\n  sql\n} = require(\"../src/db\");\n\n// --- Lấy tất cả log ---\nrouter.get(\"/\", async (req, res) => {\n  try {\n    const pool = await poolPromise;\n    const result = await pool.request().query(\"SELECT * FROM dbo.POWER_LOG\");\n    res.json(result.recordset);\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\n\n// --- Lấy log theo DEVICE_ID ---\nrouter.get(\"/device/:deviceId\", async (req, res) => {\n  try {\n    const {\n      deviceId\n    } = req.params;\n    const pool = await poolPromise;\n    const result = await pool.request().input(\"DEVICE_ID\", sql.Int, deviceId).query(\"SELECT * FROM dbo.POWER_LOG WHERE DEVICE_ID = @DEVICE_ID\");\n    res.json(result.recordset);\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\n\n// --- Thêm log mới ---\nrouter.post(\"/\", async (req, res) => {\n  const {\n    DEVICE_ID,\n    POWER,\n    VOLTAGE,\n    AMPERAGE,\n    CREATE_AT\n  } = req.body;\n  if (!DEVICE_ID || !POWER && (!VOLTAGE || !AMPERAGE)) return res.status(400).json({\n    error: \"Thiếu dữ liệu\"\n  });\n  try {\n    const pool = await poolPromise;\n    const result = await pool.request().input(\"DEVICE_ID\", sql.Int, DEVICE_ID).input(\"POWER\", sql.Float, POWER || null).input(\"VOLTAGE\", sql.Float, VOLTAGE || null).input(\"AMPERAGE\", sql.Float, AMPERAGE || null).input(\"CREATE_AT\", sql.DateTime, CREATE_AT || new Date()).query(`\n        INSERT INTO dbo.POWER_LOG(DEVICE_ID, POWER, VOLTAGE, AMPERAGE, CREATE_AT)\n        OUTPUT INSERTED.*\n        VALUES (@DEVICE_ID, @POWER, @VOLTAGE, @AMPERAGE, @CREATE_AT)\n      `);\n    res.json(result.recordset[0]);\n  } catch (err) {\n    res.status(500).json({\n      error: err.message\n    });\n  }\n});\nmodule.exports = router;","map":{"version":3,"names":["express","require","router","Router","poolPromise","sql","get","req","res","pool","result","request","query","json","recordset","err","status","error","message","deviceId","params","input","Int","post","DEVICE_ID","POWER","VOLTAGE","AMPERAGE","CREATE_AT","body","Float","DateTime","Date","module","exports"],"sources":["D:/Web/IECMS/src/routes/powerlog.js"],"sourcesContent":["// routers/powerlog.js\r\nconst express = require(\"express\");\r\nconst router = express.Router();\r\nconst { poolPromise, sql } = require(\"../src/db\");\r\n\r\n// --- Lấy tất cả log ---\r\nrouter.get(\"/\", async (req, res) => {\r\n  try {\r\n    const pool = await poolPromise;\r\n    const result = await pool.request().query(\"SELECT * FROM dbo.POWER_LOG\");\r\n    res.json(result.recordset);\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// --- Lấy log theo DEVICE_ID ---\r\nrouter.get(\"/device/:deviceId\", async (req, res) => {\r\n  try {\r\n    const { deviceId } = req.params;\r\n    const pool = await poolPromise;\r\n    const result = await pool\r\n      .request()\r\n      .input(\"DEVICE_ID\", sql.Int, deviceId)\r\n      .query(\"SELECT * FROM dbo.POWER_LOG WHERE DEVICE_ID = @DEVICE_ID\");\r\n    res.json(result.recordset);\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// --- Thêm log mới ---\r\nrouter.post(\"/\", async (req, res) => {\r\n  const { DEVICE_ID, POWER, VOLTAGE, AMPERAGE, CREATE_AT } = req.body;\r\n  if (!DEVICE_ID || (!POWER && (!VOLTAGE || !AMPERAGE)))\r\n    return res.status(400).json({ error: \"Thiếu dữ liệu\" });\r\n\r\n  try {\r\n    const pool = await poolPromise;\r\n    const result = await pool\r\n      .request()\r\n      .input(\"DEVICE_ID\", sql.Int, DEVICE_ID)\r\n      .input(\"POWER\", sql.Float, POWER || null)\r\n      .input(\"VOLTAGE\", sql.Float, VOLTAGE || null)\r\n      .input(\"AMPERAGE\", sql.Float, AMPERAGE || null)\r\n      .input(\"CREATE_AT\", sql.DateTime, CREATE_AT || new Date()).query(`\r\n        INSERT INTO dbo.POWER_LOG(DEVICE_ID, POWER, VOLTAGE, AMPERAGE, CREATE_AT)\r\n        OUTPUT INSERTED.*\r\n        VALUES (@DEVICE_ID, @POWER, @VOLTAGE, @AMPERAGE, @CREATE_AT)\r\n      `);\r\n    res.json(result.recordset[0]);\r\n  } catch (err) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}